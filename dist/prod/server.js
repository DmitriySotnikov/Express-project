(()=>{"use strict";var e={14:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GetFileInfoService=void 0;const a=s(n(773)),u=s(n(823)),c=n(272),l=n(425);class f{static execute({fileId:e}){var t;return r(this,void 0,void 0,(function*(){const n=l.commonConfig.DB_NAME,[i]=yield u.default.query(`SELECT originalname, extension, mime_type, size FROM ${n}.files WHERE id = ?`,[e]);if(!(null===(t=i[0])||void 0===t?void 0:t.name))throw new c.ApiError(a.default.BAD_REQUEST,"File not found!");return i[0]}))}}i([(0,c.service)({message:"Error getting file info!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],f,"execute",null),t.GetFileInfoService=f},60:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.upload=void 0;const o=i(n(461)),r=i(n(928)),s=o.default.diskStorage({destination:function(e,t,n){n(null,"uploads/")},filename:function(e,t,n){n(null,t.fieldname+"-"+Date.now()+r.default.extname(t.originalname))}});t.upload=(0,o.default)({storage:s}).single("file")},74:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DownloadFileService=void 0;const a=s(n(943)),u=s(n(773)),c=s(n(823)),l=n(272),f=n(425);class d{static execute({fileId:e}){return r(this,void 0,void 0,(function*(){const t=f.commonConfig.DB_NAME,[n]=yield c.default.query(`SELECT name_in_repository, originalname, mime_type FROM ${t}.files WHERE id = ?`,[e]),i=n[0];if(!i)throw new l.ApiError(u.default.BAD_REQUEST,"File not found!");return{content:yield a.default.readFile(f.commonConfig.UPLOADS_DIRECTORY+i.name_in_repository),filename:i.originalname,mimeType:i.mime_type}}))}}i([(0,l.service)({message:"Error deleting file!",status:u.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.DownloadFileService=d},83:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GetUserInfoServices=void 0;const a=s(n(773)),u=s(n(823)),c=n(121),l=n(272),f=n(425);class d{static execute({token:e}){return r(this,void 0,void 0,(function*(){const t=f.commonConfig.DB_NAME,n=yield(0,c.verifyJWT)({token:e,secret:f.commonConfig.JWT_SECRET});if(!n)throw new l.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");const{userId:i}=n,[o]=yield u.default.query(`SELECT id FROM ${t}.users WHERE login = ?`,[i]);if(!(null==o?void 0:o.length))throw new l.ApiError(a.default.BAD_REQUEST,"User not found!");return{id:o[0].id}}))}}i([(0,l.service)({message:"Error getting user info!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.GetUserInfoServices=d},96:e=>{e.exports=require("morgan")},121:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.verifyJWT=t.createToken=void 0;const o=i(n(773)),r=n(272),s=i(n(829)),a=n(425);t.createToken=({userId:e,deviceId:t,time:n})=>{try{const i={userId:e,deviceId:t};return s.default.sign(i,a.commonConfig.JWT_SECRET,{expiresIn:n})}catch(e){throw new r.ApiError(o.default.INTERNAL_SERVER_ERROR,"Error creating token!")}},t.verifyJWT=({token:e,secret:t})=>{try{return s.default.verify(e,t)}catch(e){return null}}},135:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UploadFileService=void 0;const a=s(n(773)),u=n(272),c=s(n(823)),l=n(425);class f{static execute({fileData:e}){return r(this,void 0,void 0,(function*(){const t=l.commonConfig.DB_NAME,{originalname:n,filenameInRepository:i,extension:o,mimeType:r,size:s}=e,[a]=yield c.default.query(`\n       INSERT INTO ${t}.files (name_in_repository, originalname, extension, mime_type, size)\n       VALUES (?, ?, ?, ?, ?);\n       `,[i,n,o,r,s]);return{message:"File uploaded successfully",id:a.insertId}}))}}i([(0,u.service)({message:"Error saving file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],f,"execute",null),t.UploadFileService=f},252:e=>{e.exports=require("express")},272:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.service=t.controller=t.ApiError=void 0;const r=o(n(773)),s=class extends Error{constructor(e,t,n=[]){super(t),this.status=e,this.errors=n}};t.ApiError=s,t.controller=function({message:e,status:t}){return(n,o,s)=>{const a=s.value;s.value=(...o)=>i(this,void 0,void 0,(function*(){try{return yield a.apply(n,o)}catch(n){return n.message||(n.message=e||"Internal server error!"),n.status||(n.status=t||r.default.INTERNAL_SERVER_ERROR),o[1].status(n.status).send({message:n.message})}}))}},t.service=function({message:e,status:n}){return(o,r,s)=>{const a=s.value;s.value=(...r)=>i(this,void 0,void 0,(function*(){try{return yield a.apply(o,r)}catch(i){throw i.message||(i.message=e),i.status||(i.status=n),new t.ApiError(i.status,i.message,i)}}))}}},287:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(252)),r=i(n(426)),s=n(60),a=o.default.Router();a.post("/upload",[s.upload],r.default.createFile).get("/list",r.default.getFilesList).delete("/delete/:id",r.default.deleteFile).get("/:id",r.default.getFile).get("/download/:id",r.default.downloadFile).put("/update/:id",[s.upload],r.default.updateFile),t.default=a},425:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.commonConfig=void 0;const o=i(n(928)),r=i(n(750));t.commonConfig={PREFIX:process.env.PREFIX||"api",COOKIE_TOKEN:"token",COOKIE_EXPIRES_IN:process.env.COOKIE_EXPIRES_IN||6048e5,ACCESS_TOKEN_EXPIRES_IN:process.env.TOKEN_EXPIRES_IN||"10m",REFRESH_TOKEN_EXPIRES_IN:process.env.TOKEN_EXPIRES_IN||"7d",JWT_SECRET:process.env.JWT_SECRET||"test-jwt-secret",PORT:process.env.PORT||5555,UPLOADS_DIRECTORY:o.default.join(r.default+"/uploads/"),DB_HOST:process.env.DB_HOST||"localhost",DB_USER:process.env.DB_USER||"root",DB_PASSWORD:process.env.DB_PASSWORD||"password",DB_NAME:process.env.DB_NAME||"test_db"}},426:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(773)),u=n(757),c=n(272),l=n(455),f=n(609),d=n(135),p=n(650),_=n(14),m=n(74);class E{static createFile(e,t){return r(this,void 0,void 0,(function*(){const n=e.file;if(!n)throw new c.ApiError(a.default.BAD_REQUEST,"File not found!");const i=(0,u.getFileParams)(n),o=yield d.UploadFileService.execute({fileData:i});return t.send(o)}))}static getFilesList(e,t){return r(this,void 0,void 0,(function*(){const n=Number(e.query.page)||1,i=Number(e.query.limit)||10,o=yield p.GetFileListService.execute({page:n,limit:i});return t.send(o)}))}static deleteFile(e,t){return r(this,void 0,void 0,(function*(){const n=Number(e.params.id),i=yield f.DeleteFileService.execute({fileId:n});return t.send(i)}))}static getFile(e,t){return r(this,void 0,void 0,(function*(){const n=Number(e.params.id),i=yield _.GetFileInfoService.execute({fileId:n});return t.send(i)}))}static downloadFile(e,t){return r(this,void 0,void 0,(function*(){const n=Number(e.params.id);if(!n)throw new c.ApiError(a.default.BAD_REQUEST,"File not found!");const{content:i,filename:o,mimeType:r}=yield m.DownloadFileService.execute({fileId:n});t.setHeader("Content-Type",r),t.setHeader("Content-Disposition",`attachment; filename="${o}"`),t.send(i)}))}static updateFile(e,t){return r(this,void 0,void 0,(function*(){const n=e.file,i=Number(e.params.id);if(!n)throw new c.ApiError(a.default.BAD_REQUEST,"File not found!");const o=(0,u.getFileParams)(n),r=yield l.UpdateFileService.execute(Object.assign({fileId:i},o));t.send(r)}))}}i([(0,c.controller)({message:"Error saving file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"createFile",null),i([(0,c.controller)({message:"Error getting files list!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"getFilesList",null),i([(0,c.controller)({message:"Error deleting file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"deleteFile",null),i([(0,c.controller)({message:"Error getting file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"getFile",null),i([(0,c.controller)({message:"Errror downloading file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"downloadFile",null),i([(0,c.controller)({message:"Error updating file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"updateFile",null),t.default=E},446:e=>{e.exports=require("joi")},455:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateFileService=void 0;const a=s(n(943)),u=s(n(773)),c=s(n(823)),l=n(272),f=n(425);class d{static execute({fileId:e,originalname:t,filenameInRepository:n,extension:i,mimeType:o,size:s}){var d;return r(this,void 0,void 0,(function*(){const r=f.commonConfig.DB_NAME,[p]=yield c.default.query(`SELECT name_in_repository FROM ${r}.files WHERE id = ?`,[e]),_=null===(d=p[0])||void 0===d?void 0:d.name_in_repository;if(!_)throw new l.ApiError(u.default.BAD_REQUEST,"File not found!");return yield a.default.unlink(f.commonConfig.UPLOADS_DIRECTORY+_),yield c.default.query(`\n       UPDATE ${r}.files\n       SET\n        name_in_repository = ?, \n        originalname = ?, \n        extension = ?, \n        mime_type = ?, \n        size = ?\n       WHERE id = ?\n       `,[n,t,i,o,s,e]),{message:"File updated successfully"}}))}}i([(0,l.service)({message:"Error updating file!",status:u.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.UpdateFileService=d},461:e=>{e.exports=require("multer")},469:e=>{e.exports=require("dotenv/config")},475:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RefreshServices=void 0;const a=s(n(773)),u=s(n(823)),c=n(272),l=n(121),f=n(425);class d{static execute({token:e}){return r(this,void 0,void 0,(function*(){const t=f.commonConfig.DB_NAME,n=yield(0,l.verifyJWT)({token:e,secret:f.commonConfig.JWT_SECRET});if(!n)throw new c.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");const{userId:i,deviceId:o}=n,[r]=yield u.default.query(`SELECT id FROM ${t}.users WHERE login = ?`,[i]);if(!(null==r?void 0:r.length))throw new c.ApiError(a.default.BAD_REQUEST,"User not found!");const[s]=yield u.default.query(`SELECT id FROM ${t}.sessions WHERE device_id = ? AND user_id = ?`,[o,r[0].id]);if(!(null==s?void 0:s.length))throw new c.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");const d=(0,l.createToken)({userId:i,deviceId:o,time:f.commonConfig.REFRESH_TOKEN_EXPIRES_IN});return yield u.default.query(`\n      UPDATE ${t}.sessions\n      SET refresh_token = ?\n      WHERE id = ?\n      `,[d,s[0].id]),{accessToken:(0,l.createToken)({userId:i,deviceId:o,time:f.commonConfig.ACCESS_TOKEN_EXPIRES_IN}),refreshToken:d}}))}}i([(0,c.service)({message:"Error authorization on the resource!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.RefreshServices=d},486:e=>{e.exports=require("bcrypt")},491:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SignupServices=void 0;const a=s(n(773)),u=n(575),c=s(n(823)),l=n(121),f=n(272),d=n(425);class p{static execute({login:e,password:t,deviceId:n}){return r(this,void 0,void 0,(function*(){const i=d.commonConfig.DB_NAME,[o]=yield c.default.query(`SELECT id  FROM ${i}.users WHERE login = ?`,[e]);if(null==o?void 0:o.length)throw new f.ApiError(a.default.BAD_REQUEST,"User already exists!");const r=yield(0,u.hashFunction)(t),[s]=yield c.default.query(`\n        INSERT INTO ${i}.users (login, password)\n        VALUES (?, ?);\n        `,[e,r]),p=(0,l.createToken)({userId:e,deviceId:n,time:d.commonConfig.REFRESH_TOKEN_EXPIRES_IN});return yield c.default.query(`\n        INSERT INTO ${i}.sessions (user_id, refresh_token, device_id)\n        VALUES (?, ?, ?);\n        `,[s.insertId,p,n]),{accessToken:(0,l.createToken)({userId:e,deviceId:n,time:d.commonConfig.ACCESS_TOKEN_EXPIRES_IN}),refreshToken:p}}))}}i([(0,f.service)({message:"Error creating a new user!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],p,"execute",null),t.SignupServices=p},498:e=>{e.exports=require("mysql2/promise")},575:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setCookie=t.isValid=t.hashFunction=void 0;const r=o(n(486)),s=n(425);t.hashFunction=(e,t=10)=>i(void 0,void 0,void 0,(function*(){return yield r.default.hash(e,t)})),t.isValid=(e,t)=>i(void 0,void 0,void 0,(function*(){return yield r.default.compare(e,t)})),t.setCookie=({res:e,token:t})=>{e.cookie(s.commonConfig.COOKIE_TOKEN,t,{httpOnly:!0,secure:!0,sameSite:"none",maxAge:+s.commonConfig.COOKIE_EXPIRES_IN})}},577:e=>{e.exports=require("cors")},609:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.DeleteFileService=void 0;const a=s(n(943)),u=s(n(773)),c=s(n(823)),l=n(272),f=n(425);class d{static execute({fileId:e}){var t;return r(this,void 0,void 0,(function*(){const n=f.commonConfig.DB_NAME,[i]=yield c.default.query(`SELECT name_in_repository FROM ${n}.files WHERE id = ?`,[e]),o=null===(t=i[0])||void 0===t?void 0:t.name_in_repository;if(!o)throw new l.ApiError(u.default.BAD_REQUEST,"File not found!");return yield c.default.query(`DELETE FROM ${n}.files WHERE id = ?`,[e]),yield a.default.unlink(f.commonConfig.UPLOADS_DIRECTORY+o),{message:"File deleted successfully!"}}))}}i([(0,l.service)({message:"Error deleting file!",status:u.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.DeleteFileService=d},611:e=>{e.exports=require("http")},624:function(e,t,n){var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(469);const r=o(n(577)),s=o(n(96)),a=o(n(932)),u=n(611),c=o(n(823)),l=o(n(898)),f=n(425),d=o(n(935)),p=o(n(287)),_=o(n(252)),m=(0,_.default)(),E=f.commonConfig.PORT;i(void 0,void 0,void 0,(function*(){try{const e=yield c.default.getConnection();yield e.ping(),console.log("Успешное подключение к базе данных"),e.release()}catch(e){console.error("Ошибка подключения к базе данных:",e),a.default.exit(1)}})),m.set("trust proxy",1),m.enable("trust proxy"),m.use((0,r.default)({origin:!0,credentials:!0})),m.use("/api/static",_.default.static(f.commonConfig.UPLOADS_DIRECTORY)),m.get("/favicon.ico",((e,t)=>t.status(204))),m.use((0,l.default)()),m.use((0,s.default)("dev")),m.use(_.default.json({limit:"50mb"})),m.use(_.default.urlencoded({extended:!1,limit:"50mb"})),m.use(`/${f.commonConfig.PREFIX}/file`,p.default),m.use(`/${f.commonConfig.PREFIX}`,d.default),(0,u.createServer)(m).listen(E,(()=>console.log(`Server started on port ${E}`)))},641:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.authSchema=void 0;const o=i(n(446));t.authSchema=o.default.object({login:o.default.string().required().min(3).max(50).messages({"string.empty":"Login cannot be empty","any.required":"Login is required","string.min":"Login must be at least 3 characters long","string.max":"Login must be at most 50 characters long"}),password:o.default.string().min(6).required().messages({"string.empty":"Password cannot be empty","string.min":"Password must be at least 6 characters long","any.required":"Password is required"}),deviceId:o.default.string().required().min(3).max(50).messages({"string.empty":"Device id canmot be empty ","any.required":"Device id is required","string.min":"Device id must be at least 3 characters long","string.max":"Device id must be at most 50 characters long"})})},650:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.GetFileListService=void 0;const a=s(n(773)),u=n(272),c=s(n(823)),l=n(425);class f{static execute({page:e,limit:t}){return r(this,void 0,void 0,(function*(){const n=(e-1)*t,i=l.commonConfig.DB_NAME,[o]=yield c.default.query(`SELECT id, originalname, extension, mime_type, size, upload_date\n       FROM ${i}.files\n       ORDER BY upload_date DESC \n       LIMIT ? OFFSET ?`,[t,n]),[r]=yield c.default.query(`SELECT COUNT(*) as total FROM ${i}.files`);return{files:o,total:r[0].total}}))}}i([(0,u.service)({message:"Error saving file!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],f,"execute",null),t.GetFileListService=f},712:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=s(n(773)),u=n(575),c=n(425),l=n(272),f=n(754),d=n(845),p=n(491),_=n(475),m=n(83);class E{static signin(e,t){return r(this,void 0,void 0,(function*(){const{login:n,password:i,deviceId:o}=e.body,{accessToken:r,refreshToken:s}=yield d.SigninServices.execute({login:n,password:i,deviceId:o});return(0,u.setCookie)({res:t,token:s}),t.send({accessToken:r})}))}static refreshToken(e,t){return r(this,void 0,void 0,(function*(){const n=e.cookies[c.commonConfig.COOKIE_TOKEN];if(!n)throw new l.ApiError(a.default.UNAUTHORIZED,"Invalid token!");const{accessToken:i,refreshToken:o}=yield _.RefreshServices.execute({token:n});return(0,u.setCookie)({res:t,token:o}),t.send({accessToken:i})}))}static signup(e,t){return r(this,void 0,void 0,(function*(){const{login:n,password:i,deviceId:o}=e.body,{accessToken:r,refreshToken:s}=yield p.SignupServices.execute({login:n,password:i,deviceId:o});return(0,u.setCookie)({res:t,token:s}),t.send({accessToken:r})}))}static info(e,t){return r(this,void 0,void 0,(function*(){const n=e.cookies[c.commonConfig.COOKIE_TOKEN];if(!n)throw new l.ApiError(a.default.UNAUTHORIZED,"Invalid token!");const i=yield m.GetUserInfoServices.execute({token:n});return t.send(i)}))}static logout(e,t){return r(this,void 0,void 0,(function*(){const n=e.cookies[c.commonConfig.COOKIE_TOKEN];if(!n)throw new l.ApiError(a.default.UNAUTHORIZED,"Invalid token!");t.clearCookie(c.commonConfig.COOKIE_TOKEN,{httpOnly:!0});const i=yield f.LogoutServices.execute({token:n});return t.send(i)}))}}i([(0,l.controller)({message:"Error authorization on the resource!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"signin",null),i([(0,l.controller)({message:"Error authorization on the resource!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"refreshToken",null),i([(0,l.controller)({message:"Error registration on the resource!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"signup",null),i([(0,l.controller)({message:"Internal server error!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"info",null),i([(0,l.controller)({message:"Internal server error!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object,Object]),o("design:returntype",Promise)],E,"logout",null),t.default=E},750:e=>{e.exports=require("app-root-path")},754:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LogoutServices=void 0;const a=s(n(773)),u=s(n(823)),c=n(121),l=n(272),f=n(425);class d{static execute({token:e}){return r(this,void 0,void 0,(function*(){const t=f.commonConfig.DB_NAME,n=yield(0,c.verifyJWT)({token:e,secret:f.commonConfig.JWT_SECRET});if(!n)throw new l.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");const{userId:i,deviceId:o}=n,[r]=yield u.default.query(`SELECT id FROM ${t}.users WHERE login = ?`,[i]);if(!(null==r?void 0:r.length))throw new l.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");const[s]=yield u.default.query(`DELETE FROM ${t}.sessions WHERE device_id = ? AND user_id = ?`,[o,r[0].id]);if(!(null==s?void 0:s.affectedRows))throw new l.ApiError(a.default.UNAUTHORIZED,"Unauthorized!");return{message:"Successfully logged out!"}}))}}i([(0,l.service)({message:"Error authorization on the resource!",status:a.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],d,"execute",null),t.LogoutServices=d},757:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getFileParams=void 0;const o=i(n(928));t.getFileParams=e=>({originalname:e.originalname,extension:o.default.extname(e.originalname),mimeType:e.mimetype,size:e.size,filenameInRepository:e.filename})},773:e=>{e.exports=require("http-status")},810:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.validateBody=void 0;const o=i(n(773));t.validateBody=e=>(t,n,i)=>{const{error:r}=e.validate(t.body);if(r)return n.status(o.default.BAD_REQUEST).json({message:r.details[0].message});i()}},823:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(498)),r=n(425),s=o.default.createPool({host:r.commonConfig.DB_HOST,user:r.commonConfig.DB_USER,password:r.commonConfig.DB_PASSWORD,database:r.commonConfig.DB_NAME,waitForConnections:!0,connectionLimit:10,queueLimit:0});t.default=s},829:e=>{e.exports=require("jsonwebtoken")},845:function(e,t,n){var i=this&&this.__decorate||function(e,t,n,i){var o,r=arguments.length,s=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,i);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(r<3?o(s):r>3?o(t,n,s):o(t,n))||s);return r>3&&s&&Object.defineProperty(t,n,s),s},o=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},r=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,r){function s(e){try{u(i.next(e))}catch(e){r(e)}}function a(e){try{u(i.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}u((i=i.apply(e,t||[])).next())}))},s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SigninServices=void 0;const a=n(575),u=s(n(773)),c=s(n(823)),l=n(121),f=n(272),d=n(425);class p{static execute({login:e,password:t,deviceId:n}){return r(this,void 0,void 0,(function*(){const i=d.commonConfig.DB_NAME,[o]=yield c.default.query(`SELECT id, login, password FROM ${i}.users WHERE login = ?`,[e]);if(!(null==o?void 0:o.length))throw new f.ApiError(u.default.BAD_REQUEST,"User not found!");if(!(yield(0,a.isValid)(t,o[0].password)))throw new f.ApiError(u.default.BAD_REQUEST,"Invalid password!");const r=(0,l.createToken)({userId:e,deviceId:n,time:d.commonConfig.REFRESH_TOKEN_EXPIRES_IN});return yield c.default.query(`\n      INSERT INTO ${i}.sessions (user_id, refresh_token, device_id)\n      VALUES (?, ?, ?);\n      `,[o[0].id,r,n]),{accessToken:(0,l.createToken)({userId:e,deviceId:n,time:d.commonConfig.ACCESS_TOKEN_EXPIRES_IN}),refreshToken:r}}))}}i([(0,f.service)({message:"Error authorization on the resource!",status:u.default.INTERNAL_SERVER_ERROR}),o("design:type",Function),o("design:paramtypes",[Object]),o("design:returntype",Promise)],p,"execute",null),t.SigninServices=p},898:e=>{e.exports=require("cookie-parser")},928:e=>{e.exports=require("path")},932:e=>{e.exports=require("process")},935:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=i(n(252)),r=i(n(712)),s=n(810),a=n(641),u=o.default.Router();u.post("/signin",(0,s.validateBody)(a.authSchema),r.default.signin).post("/signin/new_token",r.default.refreshToken).post("/signup",(0,s.validateBody)(a.authSchema),r.default.signup).get("/info",r.default.info).get("/logout",r.default.logout),t.default=u},943:e=>{e.exports=require("fs/promises")}},t={};!function n(i){var o=t[i];if(void 0!==o)return o.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,n),r.exports}(624)})();